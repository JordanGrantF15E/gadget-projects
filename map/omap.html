
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Gadgets flight path drawing tool</title>
<link rel="stylesheet" href="openlayers/theme/default/style.css" type="text/css">
<link rel="stylesheet" href="style.css" type="text/css">

<!--//jQuery stuff, including jQuery UI and associated style sheets-->
<link rel="stylesheet" href="css/ui-lightness/jquery-ui-1.8.23.custom.css" />
<script src="js/jquery-1.8.2.min.js"></script>
<script src="js/jquery-ui-1.8.23.custom.min.js"></script>

<style type="text/css">
	#feedback { font-size: 1.4em; }
	.linecontrol { vertical-align: center; }
	.linecolorbox {     background-color: red;
    					float: left;
    					height: 1em;
    					margin: 0.3em;
   						width: 1em;}
   	.linethickness { width: 2em; float: left;}
	.line-widget { height: auto; min-height: 1em; max-height: 2em; font-size: 1.4em;}
	.linename { border: 1px solid #dddddd; float: left; }
	#button-list .ui-selecting { background: #FECA40; }
	#button-list .ui-selected { background: #F39814; color: white; }
	#button-list { list-style-type: none; margin: 0; padding: 0; width: 100%; }
	#button-list li { margin: 3px; padding: 0.4em; font-size: 1.4em; height: auto; }

	img { height:1em; margin: 0.3em;}

	/* style stuff for openlayers maps   */
	#main {width: 100%}
	.inputs {width: 30%}
	#map {width: 70%}
	table {table-layout: fixed;
			width: 100%;}
	div .inputs {
	    width: 30%;
	    float: right;
	    height: auto;
	}
	.perfinputs {width: auto;}

</style>

<script src="openlayers/lib/OpenLayers.js"></script>
<script src="http://maps.google.com/maps/api/js?v=3&amp;sensor=false"></script>

<script type="text/javascript">
	//jQuery UI code 
    var $currentlineselected = "";
    $(document).ready(function(){
	    $("#button-list li").click(function() {
	    	if($(this).hasClass("ui-selected")){
	    			$currentlineselected="";
	    			setinputmode(0);
	    			click.deactivate();
	    	}
	    	else {
	    		$currentlineselected=$(this).attr('id');
	    		if($currentlineselected=="Line1"){currenteditlayer=linelayers[1]};
	    		if($currentlineselected=="Line2"){currenteditlayer=linelayers[2]};
	    		setinputmode(0);
	    		click.activate();
	    	};

	      	$(this).toggleClass("ui-selected").siblings().removeClass("ui-selected");
	    });
	});

/* variables for map functions, specifically flight path drawing calculations */
var firstlonlat;
var heading;
var currenteditlayer;
var currentgeocoll;
var linecounter=0;

var linelayers = new Array();

OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {
	defaultHandlerOptions: {
		'single': true,
		'double': false,
		'pixelTolerance': 0,
		'stopSingle': false,
		'stopDouble': true
	},
	initialize: function(options) {
		this.handlerOptions = OpenLayers.Util.extend({}, this.defaultHandlerOptions);
		OpenLayers.Control.prototype.initialize.apply(this, arguments);
		this.handler = new OpenLayers.Handler.Click(this, {'click': this.trigger}, this.handlerOptions);
	},
	trigger: function(e) {
		var lonlat = map.getLonLatFromPixel(e.xy);
		ol_lonlat = lonlat.clone();
		if (map.projection.projCode != ol_proj.projCode){
			ol_lonlat.transform(map.projection,ol_proj);
		};

		$inputmode++;
		setinputmode($inputmode);
		if ($inputmode==1) {
			
			firstlonlat = lonlat;
			ol_firstlonlat = ol_lonlat;
			$('#pointlat').val(ol_lonlat.lat);
		};
		if ($inputmode==2) {
			
			var secondlonlat = lonlat;
			var ol_secondlonlat = ol_lonlat;
			$hdg = OpenLayers.Spherical.computeHeading(ol_firstlonlat,ol_secondlonlat);
			
			heading = (-$hdg+360)%360;
			heading = Math.round(heading/5)*5;

		};
		if ($inputmode==3) {
			$inputmode=2;
			var secondlonlat = lonlat;
			var ol_secondlonlat = ol_lonlat;
			hdg2 = OpenLayers.Spherical.computeHeading(ol_firstlonlat,ol_secondlonlat);
			
			hdg2 = (-hdg2+360)%360;
			hdg2 = Math.round(hdg2/5)*5;
			hdgdiff = headingchange(heading,hdg2);
			
			gsmps = groundspeed(document.calcs.mach.value, document.calcs.alt.value);
			
			var pointList = [];
			
			if (Math.abs(hdgdiff)<10) {
				disttraveled = document.calcs.timestep.value * gsmps;
				var destlonlat = OpenLayers.Util.destinationVincenty(ol_firstlonlat,heading,disttraveled);
				destlonlat.transform(ol_proj,map.projection);
				var startpoint = new OpenLayers.Geometry.Point(firstlonlat.lon, firstlonlat.lat);
				var endpoint = new OpenLayers.Geometry.Point(destlonlat.lon, destlonlat.lat);
				pointList.push(startpoint);
				pointList.push(endpoint);
				firstlonlat = destlonlat;
				ol_firstlonlat = firstlonlat.clone();
				ol_firstlonlat.transform(map.projection,ol_proj);
			}
			else {	

				var numvertices = Math.abs(Math.floor(hdgdiff / 5));
				var roundturn = 5;
				var turnrad = turnradius(gsmps,document.calcs.radg.value);
				var turndir = hdgdiff/(Math.abs(hdgdiff));
				var TCoffsetheading = headingadd(heading,90*turndir);
				var ol_TClonlat = new OpenLayers.Util.destinationVincenty(ol_firstlonlat,TCoffsetheading,turnrad);
				TClonlat = ol_TClonlat.clone();
				TClonlat.transform(ol_proj,map.projection);
				var startheading = headingadd(heading,-90*turndir);
				for(var p=0; p<numvertices; ++p) {
					var verthdg = headingadd(startheading,p * roundturn * turndir);
					var ol_newDestlonlat = new OpenLayers.Util.destinationVincenty(ol_TClonlat,verthdg,turnrad);
					newDestlonlat = ol_newDestlonlat.clone();
					newDestlonlat.transform(ol_proj,map.projection);
					var newPoint = new OpenLayers.Geometry.Point(newDestlonlat.lon,newDestlonlat.lat);
					pointList.push(newPoint);
				};
				heading = headingadd(heading,hdgdiff);
				firstlonlat = newDestlonlat;
				ol_firstlonlat = firstlonlat.clone();
				ol_firstlonlat.transform(map.projection,ol_proj);
				//map.setCenter(firstlonlat);
			};
			
			//vectorLayer = new OpenLayers.Layer.Vector("Test Geometry");
			lineStr = new OpenLayers.Geometry.LineString(pointList);
			lineFeature = new OpenLayers.Feature.Vector(lineStr, null, style_red);
			if(currenteditlayer.name=="Line2"){
				lineFeature = new OpenLayers.Feature.Vector(lineStr,null,style_blue);

			};
			currenteditlayer.addFeatures(lineFeature);

		};	


	}
});

var $inputmode = 0;

function setinputmode(mode){
	$inputmode=mode;
	switch(mode)
		{
		case 0:
		  $modedescription = "pick first point for new line";
		  break;
		case 1:
		  $modedescription = "set heading";
		  break;
		case 2:
		  $modedescription = "draw line/turn to";
		  break;

		default:
		  modedescription = "unknown mode";
		};
	document.getElementById("modewindow").innerHTML = $modedescription;
};


var map, vectors, controls;
var ol_proj;
var g_proj;

var click = new OpenLayers.Control.Click();

function init(){
    map = new OpenLayers.Map({
        div: "map",
        projection: new OpenLayers.Projection("EPSG:900913")
    });
   
   
      var gphy = new OpenLayers.Layer.Google(
        "Google Physical",
        {type: google.maps.MapTypeId.TERRAIN}
    );
    var gmap = new OpenLayers.Layer.Google(
        "Google Streets", // the default
        {numZoomLevels: 20}
    );
    var ghyb = new OpenLayers.Layer.Google(
        "Google Hybrid",
        {type: google.maps.MapTypeId.HYBRID, numZoomLevels: 20}
    );
    var gsat = new OpenLayers.Layer.Google(
        "Google Satellite",
        {type: google.maps.MapTypeId.SATELLITE, numZoomLevels: 22}
    );

	blankbase = new OpenLayers.Layer.Image("Blank background",
                                        'white.png',
                                        map.maxExtent,
                                        new OpenLayers.Size(1, 1));

    ol_proj = new OpenLayers.Projection("EPSG:4326");
    g_proj = new OpenLayers.Projection("EPSG:900913");


	var kmltest = new OpenLayers.Layer.Vector("airspace", {
                projection: ol_proj,
                strategies: [new OpenLayers.Strategy.Fixed()],
                protocol: new OpenLayers.Protocol.HTTP({
                    url: "airspace.kml",
                    format: new OpenLayers.Format.KML({
                        extractStyles: true,
                        extractAttributes: true
                    })
                })
            });

    var redstyle = new OpenLayers.Style({
  			'strokeWidth': 5,
  			'strokeColor': '#E01B1B',
  			'pointRadius': 5
		})

	 // allow testing of specific renderers via "?renderer=Canvas", etc
	var renderer = OpenLayers.Util.getParameters(window.location.href).renderer;
	renderer = (renderer) ? [renderer] : OpenLayers.Layer.Vector.prototype.renderers; 


	linelayers[1] = new OpenLayers.Layer.Vector("Line1", {
                projection: ol_proj,
                strategies: [new OpenLayers.Strategy.Fixed()],
                styleMap: new OpenLayers.StyleMap(redstyle),
                renderers: renderer,
                protocol: new OpenLayers.Protocol.HTTP({
                    url: "kmldb.php",
                    params: {'layer_name': 'Line1'},
                    format: new OpenLayers.Format.KML({
                        extractStyles: false,
                        extractAttributes: false
                    })
                })
            });

    map.addLayers([ gphy, blankbase, kmltest]);

    map.addControl(new OpenLayers.Control.LayerSwitcher());



//	linelayers[1]=new OpenLayers.Layer.Vector("Line1",{
//		styleMap: new OpenLayers.StyleMap(bluestyle),
//		renderers: renderer
//	});
	linelayers[2]=new OpenLayers.Layer.Vector("Line2");

	map.addLayers([linelayers[1],linelayers[2]]);
	currenteditlayer = linelayers[1];

	map.addControl(new OpenLayers.Control.EditingToolbar(currenteditlayer));

    var startcenter = new OpenLayers.LonLat(-115.6,37.5);
    startcenter.transform(ol_proj,g_proj);

    map.setCenter(startcenter, 8);

	/*  Original code replaced by google maps above
	var ol_wms = new OpenLayers.Layer.WMS( "OpenLayers WMS","http://vmap0.tiles.osgeo.org/wms/vmap0?", {layers: 'basic'} );
	var jpl_wms = new OpenLayers.Layer.WMS( "NASA Global Mosaic","http://t1.hypercube.telascience.org/cgi-bin/landsat7",{layers: "landsat7"});
	jpl_wms.setVisibility(false);
	map.addLayers([gphy, ol_wms, jpl_wms]);
	map.addControl(new OpenLayers.Control.LayerSwitcher());
	map.setCenter(new OpenLayers.LonLat(-110, 35), 10);
	//map.zoomToMaxExtent();
	*/
	
    map.addControl(
        new OpenLayers.Control.MousePosition({
            prefix: 'coordinates: ',
            separator: ' | ',
            numDigits: 3,
            emptyString: '',
            displayProjection: ol_proj
        })
    );


	map.addControl(click);
	
	map.events.register("mousemove", map, function(e) {
		var position = this.events.getMousePosition(e);
		var lonlat = map.getLonLatFromPixel(e.xy);
		
	}); 

	init_modify();

	//click.activate();

}


function init_modify(){

	            vectors = new OpenLayers.Layer.Vector("Vector Layer", {
                
            });

            map.addLayers([vectors]);

          if (console && console.log) {
                function report(event) {
                    console.log(event.type, event.feature ? event.feature.id : event.components);
                }
                vectors.events.on({
                    "beforefeaturemodified": report,
                    "featuremodified": report,
                    "afterfeaturemodified": report,
                    "vertexmodified": report,
                    "sketchmodified": report,
                    "sketchstarted": report,
                    "sketchcomplete": report
                });
            }
            controls = {
                point: new OpenLayers.Control.DrawFeature(vectors,
                            OpenLayers.Handler.Point),
                line: new OpenLayers.Control.DrawFeature(vectors,
                            OpenLayers.Handler.Path),
                polygon: new OpenLayers.Control.DrawFeature(vectors,
                            OpenLayers.Handler.Polygon),
                regular: new OpenLayers.Control.DrawFeature(vectors,
                            OpenLayers.Handler.RegularPolygon,
                            {handlerOptions: {sides: 5}}),
                modify: new OpenLayers.Control.ModifyFeature(linelayers[2])
            };
            
            for(var key in controls) {
                map.addControl(controls[key]);
            }
            
           // map.setCenter(new OpenLayers.LonLat(0, 0), 3);
            document.getElementById('noneToggle').checked = true;


}


        function update() {
            // reset modification mode
            controls.modify.mode = OpenLayers.Control.ModifyFeature.RESHAPE;
            var rotate = document.getElementById("rotate").checked;
            if(rotate) {
                controls.modify.mode |= OpenLayers.Control.ModifyFeature.ROTATE;
            }
            var resize = document.getElementById("resize").checked;
            if(resize) {
                controls.modify.mode |= OpenLayers.Control.ModifyFeature.RESIZE;
                var keepAspectRatio = document.getElementById("keepAspectRatio").checked;
                if (keepAspectRatio) {
                    controls.modify.mode &= ~OpenLayers.Control.ModifyFeature.RESHAPE;
                }
            }
            var drag = document.getElementById("drag").checked;
            if(drag) {
                controls.modify.mode |= OpenLayers.Control.ModifyFeature.DRAG;
            }
            if (rotate || drag) {
                controls.modify.mode &= ~OpenLayers.Control.ModifyFeature.RESHAPE;
            }
            controls.modify.createVertices = document.getElementById("createVertices").checked;
            var sides = parseInt(document.getElementById("sides").value);
            sides = Math.max(3, isNaN(sides) ? 0 : sides);
            controls.regular.handler.sides = sides;
            var irregular =  document.getElementById("irregular").checked;
            controls.regular.handler.irregular = irregular;
        }

        function toggleControl(element) {
            for(key in controls) {
                var control = controls[key];
                if(element.value == key && element.checked) {
                    control.activate();
                } else {
                    control.deactivate();
                }
            }
        }
        

var style_red = {
	strokeColor: "#dc1040",
	strokeOpacity: 1,
	strokeWidth: 5,
	pointRadius: 6,
	pointerEvents: "visiblePainted"
};

var style_blue = {
	strokeColor: "#0000ff",
	strokeOpacity: 1,
	strokeWidth: 5,
	pointRadius: 6,
	pointerEvents: "visiblePainted"
};

var timestep = 5; //used for calculating distance traveled over a standard time

//calculate groundspeed given mach and altitude (standard day)
//returns groundspeed in meters/second, to work with openlayer functions
function groundspeed(mach,altitude) {
	alttemp = parseFloat(TempAtAlt(altitude));
	Ktemp = parseFloat(MachOneCalcFtoK(alttemp));
	SSatalt = 643.855 * Math.pow((Ktemp/273.15),0.5);
	gskts = mach * SSatalt;
	gsmps = parseFloat(MachOneCalcknotstomps(gskts));
	return gsmps;
}

//calculate turn radius givien groundspeed in ft/s and radial g.
//returns radius in meters, to work with other openlayer functions
function turnradius(groundspeed,radialg) {
	var gravity = 9.80665;  // meters per second squared
	var vsquared = Math.pow(groundspeed,2);
	var bankang = Math.acos(1/radialg);
	var tan_of = Math.tan(bankang);
	var gr_tan_of = tan_of * gravity;
	var turnrad = perRound(((vsquared/gr_tan_of)*10),1);
	turnrad/=10;
	return turnrad;
}


// CED subroutine for cleaning up JavaScript rounding errors
// to any reasonable number of decimal places 5/5/1997 last mod 2/19/2004
// round for decimal of (value of precision) places, default is 3
// This routine can be used to pass a number and a number for precision
// or just a number only, that is to be rounded to a set number of decimal
// places. This routine supports leading and training zeros, leading and
// trailing spaces, and padding. To prevent errors, pass variables as a string.
function perRound(num, precision) {
var precision = 3; //default value if not passed from caller, change if desired
// remark if passed from caller
precision = parseInt(precision); // make certain the decimal precision is an integer
var result1 = num * Math.pow(10, precision);
var result2 = Math.round(result1);
var result3 = result2 / Math.pow(10, precision);
return zerosPad(result3, precision);
}
function zerosPad(rndVal, decPlaces) {
var valStrg = rndVal.toString(); // Convert the number to a string
var decLoc = valStrg.indexOf("."); // Locate the decimal point
// check for a decimal
if (decLoc == -1) {
decPartLen = 0; // If no decimal, then all decimal places will be padded with 0s
// If decPlaces is greater than zero, add a decimal point
valStrg += decPlaces > 0 ? "." : "";
}
else {
decPartLen = valStrg.length - decLoc - 1; // If there is a decimal already, only the needed decimal places will be padded with 0s
}
var totalPad = decPlaces - decPartLen; // Calculate the number of decimal places that need to be padded with 0s
if (totalPad > 0) {
// Pad the string with 0s
for (var cntrVal = 1; cntrVal <= totalPad; cntrVal++)
valStrg += "0";
}
return valStrg;
}

function TempAtAlt(altitudefeet)
	{
	Fahr = 56 - (altitudefeet*3.5/1000);
	return Fahr;
	}

function MachOneCalcFtoK(Fahr)
	{
	Kelvin = (.5556 * (Fahr - 32)) + 273.15;
	return Kelvin;
	}
function MachOneCalcknotstomph(knots)
	{
	mph = 1.15155 * knots;
	return mph;
	}
function MachOneCalcknotstomps(knots)
	{
	mps = 0.514791 * knots;
	return mps;
	}
function MachOneCalcknotstoftps(knots)
	{
	ftps = 1.68895 * knots;
	return ftps;
	}
function MachOneCalcknotstokmph(knots)
	{
	kmph = 1.85325 * knots;
	return kmph;
	}
function roundSet(value)
	{
	value = Math.round(100*value)/100;
	return value;
	}
function CalcDist()
	{
	alttemp = parseFloat(TempAtAlt(document.calcs.alt.value));
	Ktemp = parseFloat(MachOneCalcFtoK(alttemp));
	SSatalt = 643.855 * Math.pow((Ktemp/273.15),0.5);
	mach = document.calcs.mach.value;
	gskts = mach * SSatalt;
	gsmps = parseFloat(MachOneCalcknotstomps(gskts));
	}
function headingchange(hdg1,hdg2) {
	var a = hdg1-hdg2;
	if(a<0){a=a+360};
	var b = hdg2-hdg1;
	if(b<0){b=b+360};
	var c=1;
	if(b>180){c=-1;}
	return Math.min(a,b)*c;
}

function headingadd(hdg,diff) {
	var a = hdg + diff;
	if(a<0){
		a=a+360;
	};
	return a%360;
}

function save_layer(){
	var $kml;
	var fmtkml = new OpenLayers.Format.KML({
		internalProjection: g_proj,
		externalProjection: ol_proj});
	$kml=fmtkml.write(linelayers[1].features);

	$phpserver = "";
	$url = $phpserver + "kmldb.php";
	$.post($url, { action: "savekml", layer_name: "Line1", layer_kml: $kml }, function(data) {});
	alert("saved");
}

function load_layer(layer_name){
	var $kml;
	var fmtkml = new OpenLayers.Format.KML();

	$url = $phpserver + "kmldb.php";
	$.post($url, { action: "loadkml", layer_name: "Line1"}, function(data) {});

}

</script>

</head>

<body onload="init()">
<h1 id="title">Gadget Flight Path Drawing Tool</h1>
<div id="main">
	<div id="map" class="bigmap"></div>
	<div class="inputs">
		<div id="modewindow">pick first point</div>
		<form name="calcs">
		<table>
			<tr>
				<th>Mach</th>
				<th>Altitude</th>
				<th>G</th>
				<th>TimeStep</th>
			</tr>
			<tr>
				<td><input class="perfinputs" id="mach" value="0.9"></input></td>
			    <td><input class="perfinputs" id="alt" value="25000"></input></td>
				<td><input class="perfinputs" id="radg" value="3"></input></td>
				<td><input class="perfinputs" id="timestep" value="10"></input></td>
			</tr>
		</table>
		</form>
	<div class="linecontrol">
		<ol id="button-list">
		    <li class="ui-widget-content line-widget" id="Line1">
				<span class="linename">Line 1 - Red</span>
				<div class="linecolorbox"></div>
				<input class="linethickness" id="linethick" value="2"></input>
				<img src="images/save_icon_small.gif" id="savelayer" onclick="save_layer()" >
		    </li>
		    <li class="ui-widget-content line-widget" id="Line2"><span class="linename">Line 2 - Blue</span></li>
		</ol>

	</div>

	</div>
	
</div>
    <div id="controls">
        <ul id="controlToggle">
            <li>
                <input type="radio" name="type" value="none" id="noneToggle"
                       onclick="toggleControl(this);" checked="checked" />
                <label for="noneToggle">navigate</label>
            </li>
            <li>
                <input type="radio" name="type" value="point" id="pointToggle" onclick="toggleControl(this);" />
                <label for="pointToggle">draw point</label>
            </li>
            <li>
                <input type="radio" name="type" value="line" id="lineToggle" onclick="toggleControl(this);" />
                <label for="lineToggle">draw line</label>
            </li>
            <li>
                <input type="radio" name="type" value="polygon" id="polygonToggle" onclick="toggleControl(this);" />
                <label for="polygonToggle">draw polygon</label>
            </li>
            <li>
                <input type="radio" name="type" value="regular" id="regularToggle" onclick="toggleControl(this);" />
                <label for="regularToggle">draw regular polygon</label>
                <label for="sides"> - sides</label>
                <input id="sides" type="text" size="2" maxlength="2"
                       name="sides" value="5" onchange="update()" />
                <ul>
                    <li>
                        <input id="irregular" type="checkbox"
                               name="irregular" onchange="update()" />
                        <label for="irregular">irregular</label>
                    </li>
                </ul>
            </li>
            <li>
                <input type="radio" name="type" value="modify" id="modifyToggle"
                       onclick="toggleControl(this);" />
                <label for="modifyToggle">modify feature</label>
                <ul>
                    <li>
                        <input id="createVertices" type="checkbox" checked
                               name="createVertices" onchange="update()" />
                        <label for="createVertices">allow vertices creation</label>
                    </li>
                    <li>
                        <input id="rotate" type="checkbox"
                               name="rotate" onchange="update()" />
                        <label for="rotate">allow rotation</label>
                    </li>
                    <li>
                        <input id="resize" type="checkbox"
                               name="resize" onchange="update()" />
                        <label for="resize">allow resizing</label>
                        (<input id="keepAspectRatio" type="checkbox"
                               name="keepAspectRatio" onchange="update()" checked="checked" />
                        <label for="keepAspectRatio">keep aspect ratio</label>)
                    </li>
                    <li>
                        <input id="drag" type="checkbox"
                               name="drag" onchange="update()" />
                        <label for="drag">allow dragging</label>
                    </li>
                </ul>
            </li>
        </ul>
    </div>


</body>
</html>
